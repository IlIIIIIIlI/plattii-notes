# Snowflake Native App写了份安全手册，把审查从噩梦变成了走过场

很多读者问：你们有没有一套完整的安全规范？每次都是遇到问题才解决，为什么不一开始就建立体系？

答案是：我们确实有，而且是被逼出来的。Snowflake Marketplace要求所有Native App必须提供完整的安全文档，不然根本过不了审查。我们花了一个月时间，写了一份14章节的安全手册，涵盖从开发到部署的所有环节。

这篇文章拆解这份手册都写了什么，以及它如何帮我们顺利通过审查。

***

### 一、为什么需要这份手册

#### Snowflake Marketplace的安全审查有多严格

我们的Native App要在Snowflake Marketplace上架。提交申请后，安全审查团队发来一份questionnaire，上面密密麻麻列了30多个问题：

你们的容器用什么基础镜像？有没有CVE扫描？多久更新一次？Critical漏洞多久修复？谁负责修复？RCR是怎么配置的？有没有hardcoded privileges？数据流向是什么样的？用户数据存在哪里？有没有事件响应计划？第三方供应商有没有做风险评估？

每个问题都要求提供**文档化的流程和证据**。口头说"我们有在做"是不行的，必须拿出白纸黑字的规范、执行记录、审计日志。

更要命的是，Snowflake还有个自动化扫描工具叫NAAAPS（Native App Anti-Abuse Pipeline Service），会扫描你的容器镜像、代码、配置。如果扫出Critical CVE、恶意软件、root权限运行、没配置RCR，申请直接被拒。

#### 我们当时的状态

说实话，这些安全实践我们都有在做。容器有扫描，漏洞有修复，RCR有配置。但问题是**没有人说得清楚到底怎么做的，也没有统一的标准**。

每个开发者有自己的习惯。有人习惯用Alpine镜像，有人用Debian。有人觉得Medium CVE要立刻修，有人觉得可以等一等。安全扫描是CI里自动跑的，但扫描报告经常没人看。

这种状态应付日常开发没问题，但面对Snowflake的审查就完全不够了。我们需要一份**能给审查团队看的、标准化的安全规范**。

***

### 二、手册的核心框架

我们参考了SOC 2、ISO 27001、NIST SSDF这些行业标准，结合Snowflake Native App的特殊要求，写了一份14章节的安全手册。

#### 第一章：安全使命与原则

这部分定义了我们的五大安全原则：

**默认安全**（Security by Default）：容器默认非root运行，SPCS后端服务默认用RCR，secrets默认不能hardcode。不需要开发者额外配置，安全是出厂设置。

**最小权限**（Least Privilege）：应用只申请必需的Caller Grants，用户只分配必需的RBAC权限。绝不贪心多要权限。

**纵深防御**（Defense in Depth）：RBAC + RCR双层防护，用户权限不够就拦，应用权限不够也拦。两道门，都要过。

**透明度**（Transparency）：所有安全决策必须文档化。为什么选这个镜像？为什么这个CVE不修？为什么要这个权限？必须有答案。

**持续改进**（Continuous Improvement）：每季度审查一次安全状况，看看哪些做得好、哪些需要改。

这五条原则是整份手册的基础。后面所有的规定都是围绕这些原则展开的。

#### 第二章：开发安全标准

这部分是最实在的，直接规定了代码层面的安全要求。

**代码安全**：所有代码必须在版本控制里（Git），主分支必须有branch protection（不能直接push）。每个PR必须经过安全focused的code review。每次commit自动跑SAST（静态代码分析）和SCA（依赖扫描）。**绝对不允许在代码里commit secrets**，只能用Snowflake Secrets。

**容器安全**（和第二篇文章直接相关）：基础镜像必须用minimal images，手册里明确提到**Chainguard或Distroless**。所有容器必须非root运行（UID > 1000）。部署前必须过CVE扫描和恶意软件扫描。每周更新依赖，每月更新基础镜像。生产镜像必须签名。

**SPCS安全**（Snowflake容器服务的特殊要求）：后端服务**必须配置RCR**（EXECUTE AS RESTRICTED\_CALLER）。应用不能hardcode任何权限grant。只申请必需的Caller Grants。所有用户输入必须验证，SQL必须用参数化查询（防注入）。

这些规定看起来很细，但每一条都对应Snowflake审查的某个检查项。比如"必须用RCR"就是Snowflake的强制要求，不配置就过不了NAAAPS扫描。

#### 第三章：架构要求

这部分定义了Native App的标准架构。

**三层架构**：前端（UI容器）→ 路由（Router容器）→ 后端（Backend容器）。前端负责展示，路由负责请求分发，后端负责数据处理。手册明确规定**不用Streamlit**，必须自己做容器化的UI。

**授权框架**：RBAC（基于用户角色）+ RCR（基于应用权限）。**两者必须同时满足，任一失败查询就失败**。这是Snowflake Native App的核心安全机制。

**数据处理**：所有数据处理必须在Snowflake内部完成，不能把消费者数据存到外部。日志里不能有消费者数据。不能在Snowflake外做persistent caching。不能把数据传到外部（除非有正当理由并且文档化）。

这些规定很严格，但也很合理。Snowflake Native App的核心价值就是"数据不出账户"，如果你的应用到处传数据，审查肯定过不了。

#### 第四章：安全测试

这部分定义了测试频率和责任方。

| 测试类型         | 频率       | 工具     | 负责人  |
| ------------ | -------- | ------ | ---- |
| SAST（静态代码分析） | 每次commit | \[工具名] | 工程团队 |
| SCA（依赖扫描）    | 每次commit | \[工具名] | 工程团队 |
| 容器CVE扫描      | 部署前      | \[工具名] | 安全团队 |
| DAST（动态应用测试） | 每周       | \[工具名] | 安全团队 |
| 渗透测试         | 每年       | 第三方    | 安全团队 |

另外还定义了测试覆盖率目标：代码覆盖率 > 80%，关键路径覆盖率100%，API端点覆盖率100%。

这些数字不是拍脑袋定的，是参考行业标准（比如SOC 2对测试的要求）。Snowflake审查时会问你的测试覆盖率，如果太低会被质疑代码质量。

#### 第五章：漏洞管理

这部分是手册里最重要的章节之一，定义了漏洞修复的SLA（服务等级协议）。

| 严重度      | 检测→分类  | 分类→修复 | 修复→部署 |
| -------- | ------ | ----- | ----- |
| Critical | 1个工作日  | 3个工作日 | 1个工作日 |
| High     | 2个工作日  | 7个工作日 | 2个工作日 |
| Medium   | 5个工作日  | 30天   | 5个工作日 |
| Low      | 10个工作日 | 90天   | 下个版本  |

这个SLA表看起来很严格，特别是Critical CVE要求5天内从发现到部署完成。但这是Snowflake审查的预期，如果你的SLA太宽松，会被质疑安全响应能力。

流程是：扫描工具检测到CVE → 安全团队分类（评估严重度和影响面）→ 分配给开发者 → 开发者修复 → 部署到生产 → 重新扫描验证。

**这里和第一篇文章的关系**：第一篇文章里Principal Engineer的做法是"忽略影响面小的CVE，但季度复查"。这种务实的风险管理策略在手册里也有体现，只是手册要求你必须**文档化为什么忽略、什么时候复查**。不是说不能忽略，而是说忽略也要有理有据。

#### 第六章：事件响应

这部分定义了安全事件的类型和响应流程。

**事件类型**：数据泄露（未授权访问消费者数据）、容器妥协（容器逃逸或提权）、供应链攻击（依赖或镜像被污染）、服务中断（SPCS不可用）、配置错误（权限配置错误）。

**响应流程**：检测（收到告警）→ 评估（判断严重度和影响面）→ 遏制（隔离受影响的组件）→ 调查（根因分析）→ 修复（部署fix）→ 沟通（通知stakeholders）→ 事后复盘（文档化教训）。

**响应SLA**：所有严重度的事件都要求3个工作日内给出初步响应。

Snowflake审查时会问：如果你们的应用发生安全事件，你们怎么处理？如果没有明确的流程，会被认为应急能力不足。

#### 第七到十四章：支撑体系

后面的章节涵盖了：

**合规与认证**（第7章）：跟踪NIST SSDF、SOC 2、ISO 27001的合规状态。定义审计时间表（内部审计每季度，外部审计每年）。

**第三方风险**（第8章）：对供应商进行分级（Tier 1关键、Tier 2高风险、Tier 3标准），定义审查频率。比如Snowflake平台本身是Tier 1，每年必须审查其SOC 2和ISO 27001认证。

**安全文档**（第9章）：列了8个必需的文档，包括架构图、组件清单、数据流图、权限清单、CVE说明、代码路径、事件响应计划、供应商评估。

**安全指标**（第10章）：定义了6个关键指标，比如MTTD（平均检测时间）< 24小时，MTTR（平均修复时间）< 7天（High级别），生产环境Critical CVE = 0。

**培训**（第11章）：要求所有开发者每年参加安全编码培训，后端开发者必须学SPCS安全，DevOps必须学容器安全。

**Marketplace合规**（第12章）：这是最关键的一章，列了提交前的检查清单，包括CVE扫描、恶意软件扫描、非root运行、RCR配置、架构图、安全问卷、SSDF文档等。还提到了NAAAPS扫描的要求。

***

### 三、手册如何帮我们通过审查

#### 审查前：用手册做自检

在正式提交Snowflake审查之前，我们按照手册的第12章（Marketplace合规）做了一遍完整的自检。

检查清单上列了12项：容器CVE扫描（无Critical/High）、恶意软件扫描（clean）、非root运行、RCR配置、架构图、安全问卷、Trust Center更新、SSDF文档等。

我们逐项检查，发现有3个问题：

1. 有一个Python容器还有2个High CVE（来自系统库）
2. Nginx容器的架构图画得不够详细，没有标注RCR的enforcement点
3. 第三方供应商的安全评估文档过期了（上次审查是18个月前）

这些问题如果直接提交审查，肯定会被打回来。我们花了一周时间修复：更新了Python容器的基础镜像、重新画了架构图、更新了供应商评估。

**手册的价值就在这里：它让我们在审查前就发现并解决了问题，而不是被审查团队指出来再返工**。

#### 审查中：用手册回答问题

Snowflake的安全问卷有30多个问题，但我们回答起来很轻松，因为手册里都有对应的章节。

审查团队问："你们的漏洞修复流程是什么？Critical漏洞多久能修复？"

我们直接给他们看手册第5章的漏洞管理流程和SLA表。Critical漏洞5天内从检测到部署，有明确的责任方和时间节点。

审查团队问："你们的容器用什么基础镜像？怎么保证安全？"

我们给他们看手册第2章的容器安全标准。基础镜像用Distroless（和第二篇文章直接关联），非root运行，每周更新依赖，每月更新基础镜像，部署前必须过CVE扫描。

审查团队问："如果发生安全事件，你们怎么处理？"

我们给他们看手册第6章的事件响应流程。7种事件类型，明确的响应步骤，3个工作日的响应SLA。

**每个问题我们都能拿出文档化的流程和证据**。审查团队看到我们有这么完整的安全手册，很多问题都是快速过一遍就批准了。

#### 审查后：审查团队的反馈

审查结束后，Snowflake的安全团队给了我们反馈："这是我们见过最清晰的安全文档之一。你们不仅有规范，还有实际的执行证据。"

他们特别提到了两点：

**第一，手册的结构很清晰**。从原则到标准到流程到指标，层层递进。审查团队很容易找到他们需要的信息。

**第二，手册和实际执行是对应的**。我们不是为了应付审查临时写的文档，而是真的在按照手册执行。比如我们给他们看了过去三个月的CVE修复记录，平均修复时间是9天（符合手册的SLA要求）。我们给他们看了容器镜像的扫描报告，生产环境0个Critical CVE（符合手册的目标）。

审查团队甚至把我们的一些实践（比如Marketplace合规检查清单、CVE修复SLA表）推荐给了其他申请上架的团队。

***

### 四、手册的实际价值

#### 价值一：把隐性知识显性化

以前团队的安全实践是靠"老员工口口相传"的。新人加入不知道该怎么做，只能问老员工或者自己摸索。

有了手册之后，所有的标准和流程都写下来了。新人onboarding的时候，直接看手册第2章（开发安全标准）和第11章（培训要求），就知道代码该怎么写、容器该怎么配置、测试该怎么做。

**手册让安全实践变成了可复制、可传承的知识**。

#### 价值二：统一团队的安全标准

以前每个开发者有自己的习惯。有人用Alpine镜像，有人用Debian slim。有人觉得Medium CVE要立刻修，有人觉得可以等下个版本。

有了手册之后，所有人都遵循同一套标准。基础镜像统一用Distroless，CVE修复统一按SLA执行，测试覆盖率统一要求80%以上。

**手册消除了团队内部的安全实践差异**。

#### 价值三：简化审查和合规流程

Snowflake的审查只是开始。以后我们还要做SOC 2认证、ISO 27001认证、客户的安全审计。

每次审查都会问类似的问题：你们的安全流程是什么？漏洞怎么管理？事件怎么响应？有了手册，我们不需要每次都从头准备材料。**手册就是我们的标准答案**。

而且手册定期更新（手册规定每季度审查一次），审查团队看到我们有持续改进的机制，信心会更强。

#### 价值四：降低安全风险

这是最根本的价值。手册定义了明确的安全底线（比如生产环境不能有Critical CVE、容器必须非root运行、后端必须配RCR），这些底线通过CI/CD流程强制执行。

开发者想部署代码，就必须满足这些要求。**手册不是写在纸上的空话，而是嵌入到日常工作流程里的硬性约束**。

过去三个月，我们的生产环境Critical CVE从平均8-12个降到了0-2个。这不是因为开发者突然变勤奋了，而是因为手册定义的流程（每周更新依赖、每月更新镜像、部署前强制扫描）让安全变成了默认行为。

***

### 五、和前两篇文章的关系

#### 第一篇：风险管理是手册的实践

第一篇文章讲的是Principal Engineer如何"忽略"57个CVE，但设定季度复查机制。这种务实的风险管理方法其实就来自手册第5章（漏洞管理）。

手册规定了严格的CVE修复SLA，但也允许**基于风险评估的例外**。如果一个Critical CVE在你的环境里影响面很小（比如攻击条件不满足），可以不立即修复，但必须：

1. 文档化评估理由（为什么影响面小）
2. 设定复查时间（比如每季度重新评估）
3. 记录在CVE tracking系统里（不能忘记）

这就是第一篇文章里Principal Engineer做的事情。他不是随意忽略CVE，而是按照手册的风险管理流程来操作。

#### 第二篇：Distroless迁移是手册的要求

第二篇文章讲的是我们如何把容器从53个CVE降到5个。这个迁移直接来自手册第2章（容器安全标准）的要求："Base Images: Use minimal images (Chainguard, Distroless)"。

手册不只是写了"必须用Distroless"，还定义了配套的要求：

* 非root运行（UID > 1000）
* 每周更新依赖
* 每月更新基础镜像
* 部署前强制CVE扫描
* 生产镜像必须签名

Distroless迁移的成功经验（多阶段构建、非root用户配置、CI/CD集成）后来也被补充到了手册的实施指南里，让其他团队可以参考。

#### 第三篇：手册是两者的基础

如果说第一篇是"战术"（如何处理单个CVE），第二篇是"战役"（如何系统性降低CVE基数），那这篇就是"战略"（如何建立可持续的安全体系）。

**手册把零散的实践固化成可复制的流程**：

* 风险管理不再是个人经验，而是文档化的评估标准
* 镜像选择不再是随机决策，而是明确的技术要求
* 安全测试不再是可选项，而是CI/CD的强制步骤

三篇文章的逻辑关系是：**从点（单个问题）→ 线（系统优化）→ 面（完整体系）**。

***

### 结语

这份14章节的安全手册不是为了写而写，而是Snowflake Marketplace审查的硬性要求。

但写完之后我们发现，**手册的价值远超过应付审查**。它让团队的安全实践从"各自为政"变成了"统一标准"，从"口口相传"变成了"可复制流程"，从"被动响应"变成了"主动防御"。

最直观的数字：生产环境Critical CVE从8-12个降到0-2个，CVE平均修复时间从21天降到9天，安全文档完成率从30%提升到85%。

但更重要的是**心态的转变**。以前我们觉得安全是负担，是开发效率的敌人。现在我们知道，好的安全体系不是限制开发，而是让开发更有信心。

当你知道你的代码在部署前会被自动扫描，你的容器会被强制要求非root运行，你的CVE会按照SLA被跟踪修复，你反而更敢大胆地写代码、更敢快速地迭代。

**因为安全不再是"事后补救"，而是"内置的护栏"**。

这是我们从这份140页手册里学到的最重要的一课。

***

### 附录：手册核心内容速查

**14个章节概览**

1. 安全使命与原则（5大原则：默认安全、最小权限、纵深防御、透明度、持续改进）
2. 开发安全标准（代码安全、容器安全、SPCS安全）
3. 架构要求（三层架构、RBAC+RCR双重防护、数据处理规范）
4. 安全测试（5类测试、测试频率、覆盖率目标）
5. 漏洞管理（CVE修复SLA、处理流程、风险评估）
6. 事件响应（5类事件、响应流程、响应SLA）
7. 合规与认证（NIST SSDF、SOC 2、ISO 27001）
8. 第三方风险（供应商分级、审查频率）
9. 安全文档（8个必需文档、审查周期）
10. 安全指标（6个KPI、目标值）
11. 培训与意识（4类培训、培训频率）
12. Marketplace合规（提交前检查清单、NAAAPS扫描）
13. 参考资源（内部文档、外部标准）
14. 变更管理（文档更新流程、沟通机制）

**关键SLA**

* Critical CVE：检测到部署完成 5个工作日
* High CVE：检测到部署完成 11个工作日
* 安全事件响应：3个工作日内给出初步反馈
* 容器依赖更新：每周
* 基础镜像更新：每月

**核心要求**

* 基础镜像：Chainguard或Distroless
* 容器运行：非root（UID > 1000）
* SPCS后端：必须配置RCR
* 代码覆盖率：> 80%
* 生产环境CVE：0个Critical

**实际成果**

* Snowflake审查：顺利通过
* 生产Critical CVE：0-2个（vs 之前8-12个）
* CVE平均修复时间：9天（vs 之前21天）
* 安全文档完成率：85%（vs 之前30%）

**和前两篇关联**

* 第一篇（风险管理）：手册第5章的实践
* 第二篇（Distroless）：手册第2章的落地
* 第三篇（体系建设）：前两篇的理论基础
